<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>リアルタイム会話ダイアライゼーション</title>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Inline styles -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
            color: #333;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .main-container {
            width: 100%;
            max-width: 800px;
            background: #ffffff;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            padding: 30px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        .header { text-align: center; }
        .header h1 { margin-bottom: 8px; color: #1a202c; }
        .header p { color: #718096; }
        
        .enrollment-section, .controls-container {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
        }
        h2 { 
            margin-top: 0; 
            border-bottom: 1px solid #e2e8f0;
            padding-bottom: 10px;
            margin-bottom: 20px;
            font-size: 1.25rem;
            color: #2d3748;
        }
        .add-speaker-form {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        #speakerNameInput {
            flex-grow: 1;
            padding: 10px 15px;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 1rem;
        }
        .button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.1s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .button:active { transform: scale(0.98); }
        .button.primary { background-color: #4299e1; color: white; }
        .button.primary:hover { background-color: #3182ce; }
        .button.enroll { background-color: #48bb78; color: white; }
        .button.enroll:hover { background-color: #38a169; }
        .button:disabled { background-color: #a0aec0; cursor: not-allowed; }

        .speaker-list { display: flex; flex-direction: column; gap: 10px; }
        .speaker-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background-color: #edf2f7;
            border-radius: 6px;
        }
        #enrollmentStatus { color: #4a5568; text-align: center; min-height: 20px; }
        
        .controls-container { text-align: center; }
        #recordButton {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: #63b3ed;
            color: white;
            border: 4px solid white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }
        #recordButton.recording { background-color: #f56565; }
        #recordButton svg { width: 32px; height: 32px; }
        .hidden { display: none; }
        #status { font-weight: 500; color: #4a5568; }
        #status.error { color: #c53030; font-weight: bold; }

        .transcript-container {
            background-color: #f7fafc;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 20px;
            min-height: 200px;
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .speaker-bubble-container { display: flex; max-width: 80%; }
        .speaker-bubble {
            padding: 12px 18px;
            border-radius: 18px;
            background-color: #e2e8f0;
        }
        .speaker-bubble-container.align-left { justify-content: flex-start; }
        .speaker-bubble-container.align-right { justify-content: flex-end; margin-left: auto; }
        .speaker-bubble-container.align-right .speaker-bubble { background-color: #bee3f8; }
        .speaker-name { font-weight: bold; margin: 0 0 5px 0; color: #2d3748;}
        p { margin: 0; }

        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #fff;
            width: 18px;
            height: 18px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div class="main-container">
        <div class="header">
            <h1>会話ダイアライザー</h1>
            <p>スピーカーを登録してから、マイクボタンを押して会話を開始してください。</p>
        </div>

        <div class="controls-container">
            <button id="recordButton" title="録音開始/停止" disabled>
                <svg id="micIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3z"></path>
                    <path d="M17 11h-1c0 2.76-2.24 5-5 5s-5-2.24-5-5H5c0 3.53 2.61 6.43 6 6.92V21h2v-3.08c3.39-.49 6-3.39 6-6.92z"></path>
                </svg>
                <svg id="stopIcon" class="hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M6 6h12v12H6z"></path>
                </svg>
            </button>
            <p id="status">初期化中...</p>
        </div>
        
        <div id="transcriptContainer" class="transcript-container">
            <!-- 文字起こしの結果がここに表示されます -->
        </div>
    </div>

    <!-- Azure Speech SDK -->
        <script>
        // --- DOM要素の参照 ---
        const recordButton = document.getElementById('recordButton');
        const micIcon = document.getElementById('micIcon');
        const stopIcon = document.getElementById('stopIcon');
        const statusEl = document.getElementById('status');
        const transcriptContainer = document.getElementById('transcriptContainer');

        // --- アプリケーションの状態 (簡略化) ---
        let recognizer = null;
        let isRecording = false;
        let conversationData = new Map();
        let speakerOrder = [];
        let speechConfig = null;

        // アプリケーションの初期化
        async function initializeApp() {
            try {
                // SDKのロード (この部分は以前の修正で完璧です)
                await new Promise((resolve, reject) => {
                    const script = document.createElement('script');
                    script.src = 'https://cdn.jsdelivr.net/npm/microsoft-cognitiveservices-speech-sdk@latest/distrib/browser/microsoft.cognitiveservices.speech.sdk.bundle.min.js';
                    script.onload = () => resolve();
                    script.onerror = (err) => reject(err);
                    document.head.appendChild(script);
                });
                
                // 認証トークンの取得 (Webアプリではキーを直接使わず、この方法が安全でベストプラクティスです)
                updateStatus("認証中...", false);
                const response = await fetch('/api/get-speech-token');
                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || `Failed to get auth token (Status: ${response.status}).`);
                }
                const { token, region } = await response.json();

                speechConfig = SpeechSDK.SpeechConfig.fromAuthorizationToken(token, region);
                speechConfig.speechRecognitionLanguage = "ja-JP";

                // イベントリスナーを設定
                recordButton.addEventListener('click', handleRecordButtonClick);

                updateStatus("準備完了。マイクボタンを押して開始してください。", false);
                recordButton.disabled = false;

            } catch (error) {
                console.error("Initialization Error:", error);
                updateStatus(`エラー: 初期化に失敗しました。 ${error.message}`, true);
                recordButton.disabled = true;
            }
        }

        // 初期化を開始
        initializeApp();

        function handleRecordButtonClick() {
            if (!isRecording) {
                startDiarization();
            } else {
                stopDiarization();
            }
        }

        // --- 主要なダイアライゼーションロジック (更新) ---
        function startDiarization() {
            if (isRecording || !speechConfig) return;

            updateUIVisuals(true);
            updateStatus("サービスに接続中...");

            // ★ 重要: ダイアライゼーションを有効にするためのプロパティ設定
            speechConfig.setProperty(SpeechSDK.PropertyId.SpeechServiceResponse_RequestWordLevelTimestamps, "true");

            const audioConfig = SpeechSDK.AudioConfig.fromDefaultMicrophoneInput();
            
            // ★ 変更点: ConversationTranscriberの代わりにSpeechRecognizerを使用
            recognizer = new SpeechSDK.SpeechRecognizer(speechConfig, audioConfig);

            // 以前の会話データをクリア
            conversationData.clear();
            speakerOrder = [];
            transcriptContainer.innerHTML = '';

            // --- イベントハンドラを設定 ---
            recognizer.sessionStarted = (s, e) => {
                updateStatus("マイクに向かって話してください...");
            };

            recognizer.sessionStopped = (s, e) => {
                updateStatus("セッションが停止しました。");
                stopDiarization();
            };

            recognizer.canceled = (s, e) => {
                let errorMessage = `キャンセルされました: ${e.reason}`;
                if (e.reason === SpeechSDK.CancellationReason.Error) {
                    errorMessage += ` | ErrorCode=${e.errorCode} | ErrorDetails=${e.errorDetails}`;
                }
                updateStatus(errorMessage, true);
                stopDiarization();
            };

            // ★ 変更点: 'transcribed' の代わりに 'recognized' イベントを使用
            recognizer.recognized = (s, e) => {
                const result = e.result;
                if (result.reason === SpeechSDK.ResultReason.RecognizedSpeech && result.text) {
                    // result.speakerId は "Speaker 1" や "Speaker 2" のような文字列になります
                    const speakerId = result.speakerId;
                    
                    if (!conversationData.has(speakerId)) {
                        conversationData.set(speakerId, []);
                        // 話者の登場順を保持
                        speakerOrder.push(speakerId);
                    }
                    
                    const utterances = conversationData.get(speakerId);
                    utterances.push(result.text);
                    renderTranscript();
                }
            };

            // 認識を開始
            recognizer.startContinuousRecognitionAsync(
                () => {}, 
                (err) => {
                    updateStatus(`エラー: ${err}`, true);
                    stopDiarization();
                }
            );
        }

        function stopDiarization() {
            // ★ 修正: 複数の停止コマンドによる競合（レースコンディション）を防ぎます。

            // グローバルなrecognizerが既に無ければ、停止処理は進行中か完了済みなので、何もしない。
            if (!recognizer) {
                return;
            }

            // グローバルなrecognizerをローカル変数に保存し、グローバル変数は即座にnullにする。
            // これにより、以降のstopDiarization()呼び出しは、冒頭のif文で即座に終了するようになる。
            const recognizerToStop = recognizer;
            recognizer = null;

            // 非同期の停止処理とクローズ処理は、ローカルに保存した参照に対して行う。
            recognizerToStop.stopContinuousRecognitionAsync(
                () => {
                    recognizerToStop.close();
                    updateUIVisuals(false); // isRecording = false に設定
                    updateStatus("録音を停止しました。");
                },
                (err) => {
                    // このエラーブロックが実行されても、ローカルのrecognizerToStopはnullではないため安全。
                    console.error("認識エンジンの停止エラー:", err);
                    recognizerToStop.close();
                    updateUIVisuals(false); // isRecording = false に設定
                    updateStatus(`停止エラー: ${err}`, true);
                }
            );
        }

        // --- UI更新ヘルパー関数 (一部変更) ---
        function renderTranscript() {
            transcriptContainer.innerHTML = '';
            
            // speakerOrder 配列を使って、話者が初めて登場した順番で表示
            for (const speakerId of speakerOrder) {
                const utterances = conversationData.get(speakerId);
                if (!utterances || utterances.length === 0) continue;

                const combinedText = utterances.join(' ');
                
                // 話者ID（"Speaker 1", "Speaker 2"）に基づいて、交互に左右に配置
                const speakerNumber = parseInt(speakerId.split(" ")[1] || "1");
                const alignClass = speakerNumber % 2 !== 0 ? 'align-left' : 'align-right';

                const bubbleContainer = document.createElement('div');
                bubbleContainer.className = `speaker-bubble-container ${alignClass}`;

                bubbleContainer.innerHTML = `
                    <div class="speaker-bubble">
                        <p class="speaker-name">${speakerId}</p>
                        <p>${combinedText}</p>
                    </div>
                `;
                transcriptContainer.appendChild(bubbleContainer);
            }
            transcriptContainer.scrollTop = transcriptContainer.scrollHeight;
        }

        function updateUIVisuals(recording) {
            isRecording = recording;
            recordButton.classList.toggle('recording', recording);
            micIcon.classList.toggle('hidden', recording);
            stopIcon.classList.toggle('hidden', !recording);
        }

        function updateStatus(text, isError = false) {
            statusEl.textContent = text;
            statusEl.classList.toggle('error', isError);
        }
    </script>
</body>
</html>
